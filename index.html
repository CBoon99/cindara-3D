<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Doppleit 3D – Create, animate, and export in an immersive web-based 3D environment.">
    <meta name="keywords" content="3D, WebGL, Three.js, animation, design, modeling, Doppleit">
    <title>Doppleit 3D</title>
    <link rel="icon" type="image/png" href="/Assets/doppleit-3d-logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #E6EFFF 0%, #D6C4FF 100%);
            color: #1A1E2E;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            transition: background 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }
        body.dark {
            background: linear-gradient(135deg, #1A1E2E 0%, #2A2D4A 100%);
            color: #E0E0E0;
        }
        .logo-container {
            text-align: center;
            margin-bottom: 12px;
        }
        #logo {
            max-width: 300px;
            width: 100%;
            animation: glitch 0.8s ease-in-out;
            box-shadow: 0 0 8px rgba(160, 132, 202, 0.5);
        }
        h1 {
            font-size: 2.25rem;
            text-align: center;
            margin-bottom: 12px;
            font-weight: 600;
        }
        @keyframes glitch {
            0% { opacity: 1; transform: translateX(0); filter: hue-rotate(0deg); }
            10% { opacity: 0.7; transform: translateX(-2px); filter: hue-rotate(20deg); }
            20% { opacity: 1; transform: translateX(2px); filter: hue-rotate(-20deg); }
            30% { opacity: 0.6; transform: translateX(-1px); filter: hue-rotate(10deg); }
            40% { opacity: 1; transform: translateX(1px); }
            60% { opacity: 0.8; transform: translateX(-1px); filter: hue-rotate(-10deg); }
            80% { opacity: 1; transform: translateX(0); filter: hue-rotate(0deg); }
            100% { opacity: 1; transform: translateX(0); }
        }
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 12px 24px;
            color: #1A1E2E;
            font-size: 1rem;
            font-weight: 500;
            transition: opacity 0.3s ease;
        }
        body.dark #loading {
            background: rgba(255, 255, 255, 0.1);
            color: #E0E0E0;
        }
        #error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 99, 71, 0.9);
            border-radius: 8px;
            padding: 12px 24px;
            color: #fff;
            font-size: 0.9rem;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #error-message.show {
            opacity: 1;
        }
        main {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        aside {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: background 0.3s ease;
        }
        body.dark aside {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        aside h2 {
            font-size: 1.35rem;
            margin-bottom: 12px;
            font-weight: 500;
        }
        aside ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        aside li {
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        aside li:hover {
            background: rgba(160, 132, 202, 0.3);
        }
        body.dark aside li:hover {
            background: rgba(138, 108, 180, 0.3);
        }
        aside li.selected {
            background: rgba(160, 132, 202, 0.5);
        }
        body.dark aside li.selected {
            background: rgba(138, 108, 180, 0.5);
        }
        aside li input {
            background: transparent;
            border: none;
            color: inherit;
            font-size: 0.9rem;
            width: 100%;
        }
        .section {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: background 0.3s ease;
        }
        body.dark .section {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .section h2 {
            font-size: 1.35rem;
            margin-bottom: 12px;
            font-weight: 500;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        button, select, input[type="checkbox"] + label, input[type="number"], input[type="color"] {
            background: linear-gradient(135deg, #A084CA, #6B728E);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            color: #fff;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(107, 115, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 40px;
        }
        body.dark button,
        body.dark select,
        body.dark input[type="checkbox"] + label,
        body.dark input[type="number"],
        body.dark input[type="color"] {
            background: linear-gradient(135deg, #8A6CB4, #5A6373);
            box-shadow: 0 4px 8px rgba(107, 115, 255, 0.2);
        }
        button:hover, select:hover, input[type="color"]:hover {
            background: linear-gradient(135deg, #B294DA, #7B829E);
            transform: scale(1.05);
            filter: brightness(1.15);
            transition: all 0.3s ease;
        }
        body.dark button:hover,
        body.dark select:hover,
        body.dark input[type="color"]:hover {
            background: linear-gradient(135deg, #9A7CC4, #6A7383);
            filter: brightness(1.05);
            transition: all 0.3s ease;
        }
        button.active, button:active {
            background: linear-gradient(135deg, #8A6CB4, #5A6373);
            transform: scale(1);
            transition: all 0.3s ease;
        }
        body.dark button.active,
        body.dark button:active {
            background: linear-gradient(135deg, #7A5CA4, #4A5363);
            transition: all 0.3s ease;
        }
        button:disabled, select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        input[type="checkbox"] {
            display: none;
        }
        input[type="checkbox"] + label {
            padding: 8px 12px;
        }
        input[type="checkbox"]:checked + label {
            background: linear-gradient(135deg, #8A6CB4, #5A6373);
            transition: all 0.3s ease;
        }
        body.dark input[type="checkbox"]:checked + label {
            background: linear-gradient(135deg, #7A5CA4, #4A5363);
            transition: all 0.3s ease;
        }
        input[type="number"] {
            width: 70px;
        }
        input[type="color"] {
            padding: 4px;
            width: 50px;
            height: 40px;
        }
        select {
            background: linear-gradient(135deg, #A084CA, #6B728E);
            transition: all 0.3s ease;
        }
        body.dark select {
            background: linear-gradient(135deg, #8A6CB4, #5A6373);
            transition: all 0.3s ease;
        }
        .canvas-container {
            flex: 1;
            background: linear-gradient(135deg, rgba(160, 132, 202, 0.2), rgba(107, 114, 142, 0.3));
            border-radius: 8px;
            min-height: 400px;
            position: relative;
            transition: background 0.3s ease;
        }
        body.dark .canvas-container {
            background: linear-gradient(135deg, rgba(138, 108, 180, 0.2), rgba(90, 99, 115, 0.3));
            transition: background 0.3s ease;
        }
        canvas {
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }
        #timeline-editor {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .keyframe-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .keyframe-list {
            max-height: 150px;
            overflow-y: auto;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: background 0.3s ease;
        }
        body.dark .keyframe-list {
            background: rgba(255, 255, 255, 0.05);
            transition: background 0.3s ease;
        }
        .keyframe-item {
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .keyframe-item:hover {
            background: rgba(160, 132, 202, 0.3);
            transition: background 0.3s ease;
        }
        body.dark .keyframe-item:hover {
            background: rgba(138, 108, 180, 0.3);
            transition: background 0.3s ease;
        }
        .keyframe-item.selected {
            background: rgba(160, 132, 202, 0.5);
            transition: background 0.3s ease;
        }
        body.dark .keyframe-item.selected {
            background: rgba(138, 108, 180, 0.5);
            transition: background 0.3s ease;
        }
        .version-footer {
            text-align: center;
            font-size: 0.8rem;
            color: #888;
            margin-top: 12px;
            transition: color 0.3s ease;
        }
        body.dark .version-footer {
            color: #aaa;
            transition: color 0.3s ease;
        }
        #status-bar {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 0.9rem;
            color: #1A1E2E;
            text-align: center;
            transition: background 0.3s ease, color 0.3s ease;
        }
        body.dark #status-bar {
            background: rgba(255, 255, 255, 0.1);
            color: #E0E0E0;
            transition: background 0.3s ease, color 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="loading">Loading…</div>
    <div id="error-message" aria-live="polite"></div>
    <div class="logo-container">
        <h1>Doppleit 3D</h1>
        <img id="logo" src="/Assets/doppleit-3d-logo.png" alt="Doppleit 3D Logo" onerror="this.style.display='none'; document.getElementById('error-message').textContent='Failed to load logo'; document.getElementById('error-message').classList.add('show');">
    </div>

    <main>
        <aside id="outliner">
            <h2>Objects</h2>
            <ul id="object-list"></ul>
        </aside>

        <aside id="inspector">
            <h2>Inspector</h2>
            <div id="inspector-content" class="controls">
                <p>Select an object to edit its properties.</p>
            </div>
        </aside>

        <div class="section" id="toolbar" role="toolbar">
            <h2>Toolbar</h2>
            <div class="controls">
                <button id="doppleit-tool-select" class="active" title="Select 3D Object (Shift+Click to multi-select)" role="button">Select Object</button>
                <button id="doppleit-tool-translate" title="Translate 3D Object (G)" role="button">Translate</button>
                <button id="doppleit-tool-rotate" title="Rotate 3D Object (R)" role="button">Rotate Object</button>
                <button id="doppleit-tool-scale" title="Scale 3D Object (S)" role="button">Scale Object</button>
                <button id="doppleit-speed-fast" class="active" title="Fast Animation Speed" role="button">Fast</button>
                <button id="doppleit-speed-final" title="Final Animation Speed" role="button">Final</button>
                <select id="doppleit-theme" title="Select Theme" aria-label="Select Theme">
                    <option value="default">Default</option>
                    <option value="ocean">Ocean</option>
                    <option value="sunset">Sunset</option>
                </select>
                <button id="doppleit-dark-mode" title="Toggle Dark Mode" role="button">Dark Mode: Off</button>
            </div>
        </div>

        <div class="section" id="prefab-library">
            <h2>Prefabs</h2>
            <div class="controls">
                <button id="add-cube" title="Add Cube to Scene" role="button">Cube</button>
                <button id="add-sphere" title="Add Sphere to Scene" role="button">Sphere</button>
                <button id="add-cone" title="Add Cone to Scene" role="button">Cone</button>
                <button id="add-torus" title="Add Torus to Scene" role="button">Torus</button>
                <button id="add-plane" title="Add Plane to Scene" role="button">Plane</button>
            </div>
        </div>

        <div class="section" id="scene">
            <h2>Scene</h2>
            <div class="controls">
                <button id="doppleit-reset-view" title="Reset Camera View" role="button">Reset View</button>
                <button id="doppleit-clear-scene" title="Clear Scene" role="button">Clear Scene</button>
                <input type="checkbox" id="doppleit-toggle-grid">
                <label for="doppleit-toggle-grid" title="Toggle Grid Visibility" aria-label="Toggle Grid Visibility">Toggle Grid</label>
                <input type="number" id="doppleit-duration" min="1" value="1" title="Animation Duration (seconds)" aria-label="Animation Duration">
                <select id="doppleit-fps" title="Frames Per Second" aria-label="Frames Per Second">
                    <option value="30">30 FPS</option>
                    <option value="60">60 FPS</option>
                    <option value="120">120 FPS</option>
                </select>
            </div>
            <div class="canvas-container" role="application" aria-label="3D interactive canvas">
                <canvas id="doppleit-three-canvas"></canvas>
            </div>
        </div>

        <div class="section" id="scene-settings">
            <h2>Scene Settings</h2>
            <div class="controls">
                <input type="color" id="background-color" value="#000000" title="Set Background Color" aria-label="Set Background Color">
                <input type="number" id="camera-target-x" value="0" step="0.1" title="Camera Target X" aria-label="Camera Target X">
                <input type="number" id="camera-target-y" value="0" step="0.1" title="Camera Target Y" aria-label="Camera Target Y">
                <input type="number" id="camera-target-z" value="0" step="0.1" title="Camera Target Z" aria-label="Camera Target Z">
                <button id="reset-scene" title="Reset Scene to Default" role="button">Reset Scene</button>
            </div>
        </div>

        <div class="section" id="material-editor">
            <h2>Material Editor</h2>
            <div class="controls">
                <input type="color" id="material-color" value="#A084CA" title="Set Material Color" aria-label="Set Material Color">
                <input type="checkbox" id="material-wireframe">
                <label for="material-wireframe" title="Toggle Wireframe Mode" aria-label="Toggle Wireframe Mode">Wireframe</label>
                <input type="number" id="material-opacity" min="0" max="1" step="0.1" value="1" title="Set Material Opacity" aria-label="Set Material Opacity">
            </div>
        </div>

        <div class="section" id="lighting-controls">
            <h2>Lighting</h2>
            <div class="controls">
                <h3>Ambient Light</h3>
                <input type="color" id="ambient-color" value="#ffffff" title="Ambient Light Color" aria-label="Ambient Light Color">
                <input type="number" id="ambient-intensity" min="0" max="1" step="0.1" value="0.5" title="Ambient Light Intensity" aria-label="Ambient Light Intensity">
                <h3>Directional Light</h3>
                <input type="color" id="directional-color" value="#ffffff" title="Directional Light Color" aria-label="Directional Light Color">
                <input type="number" id="directional-intensity" min="0" max="1" step="0.1" value="0.5" title="Directional Light Intensity" aria-label="Directional Light Intensity">
                <input type="number" id="directional-x" value="5" step="0.1" title="Directional Light X Position" aria-label="Directional Light X Position">
                <input type="number" id="directional-y" value="5" step="0.1" title="Directional Light Y Position" aria-label="Directional Light Y Position">
                <input type="number" id="directional-z" value="5" step="0.1" title="Directional Light Z Position" aria-label="Directional Light Z Position">
            </div>
        </div>

        <div class="section" id="timeline">
            <h2>Timeline</h2>
            <div class="controls">
                <button id="doppleit-play-pause" title="Play/Pause Animation" role="button">Play</button>
                <button id="doppleit-stop" title="Stop Animation" role="button">Stop</button>
            </div>
            <div id="timeline-editor">
                <div class="keyframe-controls">
                    <button id="add-keyframe" title="Add Keyframe for Selected Object" role="button">Add Keyframe</button>
                    <input type="number" id="keyframe-time" min="0" step="0.1" value="0" title="Keyframe Time (seconds)" aria-label="Keyframe Time">
                </div>
                <div class="keyframe-list" id="keyframe-list"></div>
            </div>
        </div>

        <div class="section" id="state">
            <h2>State</h2>
            <div class="controls">
                <button id="doppleit-save" title="Save Scene State" role="button">Save</button>
                <button id="doppleit-load" title="Load Scene State" role="button">Load</button>
                <button id="doppleit-import-json" title="Import Scene State via Drag & Drop" role="button">Import JSON</button>
            </div>
        </div>

        <div class="section" id="export">
            <h2>Export</h2>
            <div class="controls">
                <button id="doppleit-export-json" title="Export Scene as JSON" role="button">JSON</button>
                <button id="doppleit-export-embed" title="Export Embeddable HTML" role="button">Embed</button>
            </div>
        </div>

        <div id="status-bar">Mode: Select Object</div>
    </main>

    <div class="version-footer">Doppleit 3D v1.0</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r165/three.min.js"></script>
    <script src="https://unpkg.com/three@0.165.0/examples/jsm/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/three@0.165.0/examples/jsm/controls/TransformControls.js"></script>
    <script>
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const canvas = document.getElementById('doppleit-three-canvas');
        const objectList = document.getElementById('object-list');
        const inspectorContent = document.getElementById('inspector-content');
        const statusBar = document.getElementById('status-bar');
        const playPauseBtn = document.getElementById('doppleit-play-pause');
        const keyframeList = document.getElementById('keyframe-list');
        let scene, camera, renderer, orbitControls, transformControls, gridHelper, ambientLight, directionalLight;
        let objects = [];
        let selectedObject = null;
        let currentMode = 'select';
        let isDarkMode = false;
        let animationSpeed = 'fast';
        let isPlaying = false;
        let keyframes = {};
        let animationTime = 0;
        let animationDuration = 1;
        let fps = 60;

        // Initialize Three.js Scene
        function init() {
            try {
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
                renderer.setSize(canvas.clientWidth, canvas.clientHeight);
                renderer.setPixelRatio(window.devicePixelRatio);

                camera.position.set(5, 5, 5);
                camera.lookAt(0, 0, 0);

                orbitControls = new THREE.OrbitControls(camera, renderer.domElement);
                orbitControls.enableDamping = true;
                orbitControls.dampingFactor = 0.05;

                transformControls = new THREE.TransformControls(camera, renderer.domElement);
                transformControls.addEventListener('dragging-changed', (event) => {
                    orbitControls.enabled = !event.value;
                });
                scene.add(transformControls);

                gridHelper = new THREE.GridHelper(10, 10);
                scene.add(gridHelper);

                ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
                scene.add(ambientLight);

                directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
                directionalLight.position.set(5, 5, 5);
                scene.add(directionalLight);

                window.addEventListener('resize', () => {
                    camera.aspect = canvas.clientWidth / canvas.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
                });

                loading.style.display = 'none';
                animate();
            } catch (err) {
                showError(`Failed to initialize Three.js: ${err.message}`);
            }
        }

        // Animation Loop
        function animate() {
            requestAnimationFrame(animate);
            if (isPlaying) {
                animationTime += 1 / fps;
                if (animationTime > animationDuration) animationTime = 0;
                updateAnimation();
            }
            orbitControls.update();
            renderer.render(scene, camera);
        }

        // Add Object to Scene
        function addObject(type) {
            let geometry, material, mesh;
            material = new THREE.MeshPhongMaterial({ color: 0xA084CA });
            switch (type) {
                case 'cube':
                    geometry = new THREE.BoxGeometry();
                    break;
                case 'sphere':
                    geometry = new THREE.SphereGeometry(0.5, 32, 32);
                    break;
                case 'cone':
                    geometry = new THREE.ConeGeometry(0.5, 1, 32);
                    break;
                case 'torus':
                    geometry = new THREE.TorusGeometry(0.5, 0.2, 16, 100);
                    break;
                case 'plane':
                    geometry = new THREE.PlaneGeometry(1, 1);
                    break;
            }
            mesh = new THREE.Mesh(geometry, material);
            mesh.name = `${type}_${objects.length}`;
            scene.add(mesh);
            objects.push(mesh);
            updateObjectList();
            selectObject(mesh);
        }

        // Update Object List
        function updateObjectList() {
            objectList.innerHTML = '';
            objects.forEach(obj => {
                const li = document.createElement('li');
                li.textContent = obj.name;
                li.className = obj === selectedObject ? 'selected' : '';
                li.addEventListener('click', () => selectObject(obj));
                objectList.appendChild(li);
            });
        }

        // Select Object
        function selectObject(obj) {
            selectedObject = obj;
            updateObjectList();
            transformControls.detach();
            if (obj && currentMode !== 'select') {
                transformControls.attach(obj);
                transformControls.setMode(currentMode);
            }
            updateInspector();
        }

        // Update Inspector
        function updateInspector() {
            if (!selectedObject) {
                inspectorContent.innerHTML = '<p>Select an object to edit its properties.</p>';
                return;
            }
            inspectorContent.innerHTML = `
                <div class="controls">
                    <h3>${selectedObject.name}</h3>
                    <label>Position X: <input type="number" id="pos-x" value="${selectedObject.position.x}" step="0.1"></label>
                    <label>Position Y: <input type="number" id="pos-y" value="${selectedObject.position.y}" step="0.1"></label>
                    <label>Position Z: <input type="number" id="pos-z" value="${selectedObject.position.z}" step="0.1"></label>
                    <label>Rotation X: <input type="number" id="rot-x" value="${selectedObject.rotation.x}" step="0.1"></label>
                    <label>Rotation Y: <input type="number" id="rot-y" value="${selectedObject.rotation.y}" step="0.1"></label>
                    <label>Rotation Z: <input type="number" id="rot-z" value="${selectedObject.rotation.z}" step="0.1"></label>
                    <label>Scale X: <input type="number" id="scale-x" value="${selectedObject.scale.x}" step="0.1"></label>
                    <label>Scale Y: <input type="number" id="scale-y" value="${selectedObject.scale.y}" step="0.1"></label>
                    <label>Scale Z: <input type="number" id="scale-z" value="${selectedObject.scale.z}" step="0.1"></label>
                </div>
            `;
            document.getElementById('pos-x').addEventListener('input', (e) => selectedObject.position.x = parseFloat(e.target.value));
            document.getElementById('pos-y').addEventListener('input', (e) => selectedObject.position.y = parseFloat(e.target.value));
            document.getElementById('pos-z').addEventListener('input', (e) => selectedObject.position.z = parseFloat(e.target.value));
            document.getElementById('rot-x').addEventListener('input', (e) => selectedObject.rotation.x = parseFloat(e.target.value));
            document.getElementById('rot-y').addEventListener('input', (e) => selectedObject.rotation.y = parseFloat(e.target.value));
            document.getElementById('rot-z').addEventListener('input', (e) => selectedObject.rotation.z = parseFloat(e.target.value));
            document.getElementById('scale-x').addEventListener('input', (e) => selectedObject.scale.x = parseFloat(e.target.value));
            document.getElementById('scale-y').addEventListener('input', (e) => selectedObject.scale.y = parseFloat(e.target.value));
            document.getElementById('scale-z').addEventListener('input', (e) => selectedObject.scale.z = parseFloat(e.target.value));
        }

        // Update Animation
        function updateAnimation() {
            if (!selectedObject || !keyframes[selectedObject.name]) return;
            const frames = keyframes[selectedObject.name].sort((a, b) => a.time - b.time);
            if (frames.length < 2) return;

            let startFrame, endFrame;
            for (let i = 0; i < frames.length - 1; i++) {
                if (animationTime >= frames[i].time && animationTime <= frames[i + 1].time) {
                    startFrame = frames[i];
                    endFrame = frames[i + 1];
                    break;
                }
            }
            if (!startFrame || !endFrame) return;

            const t = (animationTime - startFrame.time) / (endFrame.time - startFrame.time);
            selectedObject.position.lerpVectors(startFrame.position, endFrame.position, t);
            selectedObject.rotation.lerpVectors(startFrame.rotation, endFrame.rotation, t);
            selectedObject.scale.lerpVectors(startFrame.scale, endFrame.scale, t);
        }

        // Add Keyframe
        function addKeyframe() {
            if (!selectedObject) {
                showError('Select an object to add a keyframe.');
                return;
            }
            const time = parseFloat(document.getElementById('keyframe-time').value);
            if (!keyframes[selectedObject.name]) keyframes[selectedObject.name] = [];
            keyframes[selectedObject.name].push({
                time,
                position: selectedObject.position.clone(),
                rotation: selectedObject.rotation.clone(),
                scale: selectedObject.scale.clone(),
            });
            updateKeyframeList();
        }

        // Update Keyframe List
        function updateKeyframeList() {
            keyframeList.innerHTML = '';
            if (!selectedObject || !keyframes[selectedObject.name]) return;
            keyframes[selectedObject.name].forEach((frame, index) => {
                const div = document.createElement('div');
                div.className = 'keyframe-item';
                div.textContent = `Time: ${frame.time}s`;
                div.addEventListener('click', () => {
                    document.getElementById('keyframe-time').value = frame.time;
                });
                keyframeList.appendChild(div);
            });
        }

        // Show Error
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            setTimeout(() => errorMessage.classList.remove('show'), 3000);
        }

        // Event Listeners
        document.getElementById('doppleit-tool-select').addEventListener('click', () => {
            currentMode = 'select';
            transformControls.detach();
            document.querySelectorAll('#toolbar button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('doppleit-tool-select').classList.add('active');
            statusBar.textContent = 'Mode: Select Object';
        });

        document.getElementById('doppleit-tool-translate').addEventListener('click', () => {
            currentMode = 'translate';
            if (selectedObject) {
                transformControls.attach(selectedObject);
                transformControls.setMode('translate');
            }
            document.querySelectorAll('#toolbar button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('doppleit-tool-translate').classList.add('active');
            statusBar.textContent = 'Mode: Translate';
        });

        document.getElementById('doppleit-tool-rotate').addEventListener('click', () => {
            currentMode = 'rotate';
            if (selectedObject) {
                transformControls.attach(selectedObject);
                transformControls.setMode('rotate');
            }
            document.querySelectorAll('#toolbar button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('doppleit-tool-rotate').classList.add('active');
            statusBar.textContent = 'Mode: Rotate';
        });

        document.getElementById('doppleit-tool-scale').addEventListener('click', () => {
            currentMode = 'scale';
            if (selectedObject) {
                transformControls.attach(selectedObject);
                transformControls.setMode('scale');
            }
            document.querySelectorAll('#toolbar button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('doppleit-tool-scale').classList.add('active');
            statusBar.textContent = 'Mode: Scale';
        });

        document.getElementById('doppleit-speed-fast').addEventListener('click', () => {
            animationSpeed = 'fast';
            fps = 60;
            document.getElementById('doppleit-speed-fast').classList.add('active');
            document.getElementById('doppleit-speed-final').classList.remove('active');
        });

        document.getElementById('doppleit-speed-final').addEventListener('click', () => {
            animationSpeed = 'final';
            fps = 30;
            document.getElementById('doppleit-speed-final').classList.add('active');
            document.getElementById('doppleit-speed-fast').classList.remove('active');
        });

        document.getElementById('doppleit-theme').addEventListener('change', (e) => {
            const value = e.target.value;
            if (value === 'ocean') {
                document.body.style.background = 'linear-gradient(135deg, #1E90FF 0%, #00CED1 100%)';
            } else if (value === 'sunset') {
                document.body.style.background = 'linear-gradient(135deg, #FF4500 0%, #FFD700 100%)';
            } else {
                document.body.style.background = isDarkMode ? 'linear-gradient(135deg, #1A1E2E 0%, #2A2D4A 100%)' : 'linear-gradient(135deg, #E6EFFF 0%, #D6C4FF 100%)';
            }
        });

        document.getElementById('doppleit-dark-mode').addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark');
            document.getElementById('doppleit-dark-mode').textContent = `Dark Mode: ${isDarkMode ? 'On' : 'Off'}`;
            document.getElementById('doppleit-theme').value = 'default';
        });

        document.getElementById('add-cube').addEventListener('click', () => addObject('cube'));
        document.getElementById('add-sphere').addEventListener('click', () => addObject('sphere'));
        document.getElementById('add-cone').addEventListener('click', () => addObject('cone'));
        document.getElementById('add-torus').addEventListener('click', () => addObject('torus'));
        document.getElementById('add-plane').addEventListener('click', () => addObject('plane'));

        document.getElementById('doppleit-reset-view').addEventListener('click', () => {
            camera.position.set(5, 5, 5);
            camera.lookAt(0, 0, 0);
            orbitControls.reset();
        });

        document.getElementById('doppleit-clear-scene').addEventListener('click', () => {
            objects.forEach(obj => scene.remove(obj));
            objects = [];
            selectedObject = null;
            transformControls.detach();
            keyframes = {};
            updateObjectList();
            updateInspector();
            updateKeyframeList();
        });

        document.getElementById('doppleit-toggle-grid').addEventListener('change', (e) => {
            gridHelper.visible = e.target.checked;
        });

        document.getElementById('doppleit-duration').addEventListener('input', (e) => {
            animationDuration = parseFloat(e.target.value);
        });

        document.getElementById('doppleit-fps').addEventListener('change', (e) => {
            fps = parseInt(e.target.value);
        });

        document.getElementById('background-color').addEventListener('input', (e) => {
            scene.background = new THREE.Color(e.target.value);
        });

        document.getElementById('camera-target-x').addEventListener('input', (e) => {
            camera.lookAt(parseFloat(e.target.value), camera.lookAt.y, camera.lookAt.z);
        });

        document.getElementById('camera-target-y').addEventListener('input', (e) => {
            camera.lookAt(camera.lookAt.x, parseFloat(e.target.value), camera.lookAt.z);
        });

        document.getElementById('camera-target-z').addEventListener('input', (e) => {
            camera.lookAt(camera.lookAt.x, camera.lookAt.y, parseFloat(e.target.value));
        });

        document.getElementById('reset-scene').addEventListener('click', () => {
            scene.background = new THREE.Color(0x000000);
            camera.position.set(5, 5, 5);
            camera.lookAt(0, 0, 0);
            document.getElementById('background-color').value = '#000000';
            document.getElementById('camera-target-x').value = 0;
            document.getElementById('camera-target-y').value = 0;
            document.getElementById('camera-target-z').value = 0;
        });

        document.getElementById('material-color').addEventListener('input', (e) => {
            if (selectedObject) selectedObject.material.color.set(e.target.value);
        });

        document.getElementById('material-wireframe').addEventListener('change', (e) => {
            if (selectedObject) selectedObject.material.wireframe = e.target.checked;
        });

        document.getElementById('material-opacity').addEventListener('input', (e) => {
            if (selectedObject) {
                selectedObject.material.opacity = parseFloat(e.target.value);
                selectedObject.material.transparent = true;
            }
        });

        document.getElementById('ambient-color').addEventListener('input', (e) => {
            ambientLight.color.set(e.target.value);
        });

        document.getElementById('ambient-intensity').addEventListener('input', (e) => {
            ambientLight.intensity = parseFloat(e.target.value);
        });

        document.getElementById('directional-color').addEventListener('input', (e) => {
            directionalLight.color.set(e.target.value);
        });

        document.getElementById('directional-intensity').addEventListener('input', (e) => {
            directionalLight.intensity = parseFloat(e.target.value);
        });

        document.getElementById('directional-x').addEventListener('input', (e) => {
            directionalLight.position.x = parseFloat(e.target.value);
        });

        document.getElementById('directional-y').addEventListener('input', (e) => {
            directionalLight.position.y = parseFloat(e.target.value);
        });

        document.getElementById('directional-z').addEventListener('input', (e) => {
            directionalLight.position.z = parseFloat(e.target.value);
        });

        document.getElementById('doppleit-play-pause').addEventListener('click', () => {
            isPlaying = !isPlaying;
            playPauseBtn.textContent = isPlaying ? 'Pause' : 'Play';
        });

        document.getElementById('doppleit-stop').addEventListener('click', () => {
            isPlaying = false;
            animationTime = 0;
            playPauseBtn.textContent = 'Play';
            objects.forEach(obj => {
                if (keyframes[obj.name] && keyframes[obj.name].length > 0) {
                    const frame = keyframes[obj.name][0];
                    obj.position.copy(frame.position);
                    obj.rotation.copy(frame.rotation);
                    obj.scale.copy(frame.scale);
                }
            });
        });

        document.getElementById('add-keyframe').addEventListener('click', addKeyframe);

        document.getElementById('doppleit-save').addEventListener('click', () => {
            const state = {
                objects: objects.map(obj => ({
                    name: obj.name,
                    type: obj.geometry.type,
                    position: obj.position.toArray(),
                    rotation: obj.rotation.toArray(),
                    scale: obj.scale.toArray(),
                    material: {
                        color: obj.material.color.getHex(),
                        opacity: obj.material.opacity,
                        wireframe: obj.material.wireframe,
                    },
                })),
                keyframes,
                scene: {
                    background: scene.background.getHex(),
                },
            };
            const blob = new Blob([JSON.stringify(state)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'doppleit-scene.json';
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('doppleit-load').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const state = JSON.parse(event.target.result);
                        objects.forEach(obj => scene.remove(obj));
                        objects = [];
                        state.objects.forEach(objData => {
                            let geometry;
                            switch (objData.type) {
                                case 'BoxGeometry':
                                    geometry = new THREE.BoxGeometry();
                                    break;
                                case 'SphereGeometry':
                                    geometry = new THREE.SphereGeometry(0.5, 32, 32);
                                    break;
                                case 'ConeGeometry':
                                    geometry = new THREE.ConeGeometry(0.5, 1, 32);
                                    break;
                                case 'TorusGeometry':
                                    geometry = new THREE.TorusGeometry(0.5, 0.2, 16, 100);
                                    break;
                                case 'PlaneGeometry':
                                    geometry = new THREE.PlaneGeometry(1, 1);
                                    break;
                            }
                            const material = new THREE.MeshPhongMaterial({
                                color: objData.material.color,
                                opacity: objData.material.opacity,
                                transparent: true,
                                wireframe: objData.material.wireframe,
                            });
                            const mesh = new THREE.Mesh(geometry, material);
                            mesh.name = objData.name;
                            mesh.position.fromArray(objData.position);
                            mesh.rotation.fromArray(objData.rotation);
                            mesh.scale.fromArray(objData.scale);
                            scene.add(mesh);
                            objects.push(mesh);
                        });
                        keyframes = state.keyframes || {};
                        scene.background = new THREE.Color(state.scene.background);
                        document.getElementById('background-color').value = '#' + state.scene.background.toString(16).padStart(6, '0');
                        updateObjectList();
                        updateInspector();
                        updateKeyframeList();
                    } catch (err) {
                        showError(`Failed to load scene: ${err.message}`);
                    }
                };
                reader.readAsText(file);
            });
            input.click();
        });

        document.getElementById('doppleit-import-json').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const state = JSON.parse(event.target.result);
                        objects.forEach(obj => scene.remove(obj));
                        objects = [];
                        state.objects.forEach(objData => {
                            let geometry;
                            switch (objData.type) {
                                case 'BoxGeometry':
                                    geometry = new THREE.BoxGeometry();
                                    break;
                                case 'SphereGeometry':
                                    geometry = new THREE.SphereGeometry(0.5, 32, 32);
                                    break;
                                case 'ConeGeometry':
                                    geometry = new THREE.ConeGeometry(0.5, 1, 32);
                                    break;
                                case 'TorusGeometry':
                                    geometry = new THREE.TorusGeometry(0.5, 0.2, 16, 100);
                                    break;
                                case 'PlaneGeometry':
                                    geometry = new THREE.PlaneGeometry(1, 1);
                                    break;
                            }
                            const material = new THREE.MeshPhongMaterial({
                                color: objData.material.color,
                                opacity: objData.material.opacity,
                                transparent: true,
                                wireframe: objData.material.wireframe,
                            });
                            const mesh = new THREE.Mesh(geometry, material);
                            mesh.name = objData.name;
                            mesh.position.fromArray(objData.position);
                            mesh.rotation.fromArray(objData.rotation);
                            mesh.scale.fromArray(objData.scale);
                            scene.add(mesh);
                            objects.push(mesh);
                        });
                        keyframes = state.keyframes || {};
                        scene.background = new THREE.Color(state.scene.background);
                        document.getElementById('background-color').value = '#' + state.scene.background.toString(16).padStart(6, '0');
                        updateObjectList();
                        updateInspector();
                        updateKeyframeList();
                    } catch (err) {
                        showError(`Failed to import scene: ${err.message}`);
                    }
                };
                reader.readAsText(file);
            });
            input.click();
        });

        document.getElementById('doppleit-export-json').addEventListener('click', () => {
            const state = {
                objects: objects.map(obj => ({
                    name: obj.name,
                    type: obj.geometry.type,
                    position: obj.position.toArray(),
                    rotation: obj.rotation.toArray(),
                    scale: obj.scale.toArray(),
                    material: {
                        color: obj.material.color.getHex(),
                        opacity: obj.material.opacity,
                        wireframe: obj.material.wireframe,
                    },
                })),
                keyframes,
                scene: {
                    background: scene.background.getHex(),
                },
            };
            const blob = new Blob([JSON.stringify(state)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'doppleit-scene.json';
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('doppleit-export-embed').addEventListener('click', () => {
            const state = {
                objects: objects.map(obj => ({
                    name: obj.name,
                    type: obj.geometry.type,
                    position: obj.position.toArray(),
                    rotation: obj.rotation.toArray(),
                    scale: obj.scale.toArray(),
                    material: {
                        color: obj.material.color.getHex(),
                        opacity: obj.material.opacity,
                        wireframe: obj.material.wireframe,
                    },
                })),
                scene: {
                    background: scene.background.getHex(),
                },
            };
            const html = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doppleit 3D Embed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r165/three.min.js"></script>
    <script src="https://unpkg.com/three@0.165.0/examples/jsm/controls/OrbitControls.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { width: 100%; height: 100vh; }
    </style>
</head>
<body>
    <canvas id="embed-canvas"></canvas>
    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('embed-canvas'), antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        camera.position.set(5, 5, 5);
        camera.lookAt(0, 0, 0);

        const orbitControls = new THREE.OrbitControls(camera, renderer.domElement);
        orbitControls.enableDamping = true;
        orbitControls.dampingFactor = 0.05;

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(5, 5, 5);
        scene.add(directionalLight);

        scene.background = new THREE.Color(${state.scene.background});

        ${state.objects.map(obj => `
            const geometry_${obj.name} = new THREE.${obj.type}(${obj.type === 'BoxGeometry' ? '' : obj.type === 'SphereGeometry' ? '0.5, 32, 32' : obj.type === 'ConeGeometry' ? '0.5, 1, 32' : obj.type === 'TorusGeometry' ? '0.5, 0.2, 16, 100' : '1, 1'});
            const material_${obj.name} = new THREE.MeshPhongMaterial({ color: ${obj.material.color}, opacity: ${obj.material.opacity}, transparent: true, wireframe: ${obj.material.wireframe} });
            const mesh_${obj.name} = new THREE.Mesh(geometry_${obj.name}, material_${obj.name});
            mesh_${obj.name}.position.fromArray([${obj.position.join(',')}]);
            mesh_${obj.name}.rotation.fromArray([${obj.rotation.join(',')}]);
            mesh_${obj.name}.scale.fromArray([${obj.scale.join(',')}]);
            scene.add(mesh_${obj.name});
        `).join('\n')}

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        function animate() {
            requestAnimationFrame(animate);
            orbitControls.update();
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
            `;
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'doppleit-embed.html';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'g') document.getElementById('doppleit-tool-translate').click();
            if (e.key === 'r') document.getElementById('doppleit-tool-rotate').click();
            if (e.key === 's') document.getElementById('doppleit-tool-scale').click();
        });

        // Initialize
        init();
    </script>
</body>
</html>